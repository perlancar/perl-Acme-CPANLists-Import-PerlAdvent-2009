<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.17 (Pod::Simple 3.10, Perl::Tidy 20071205) on 2009-12-06 00:15:06 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2009 Perl Advent Calendar: Santy Claus, why? Why are you taking our Perl module? WHY?</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="mod56.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2009-12</a>-06</h1>
<h2 align="center">Santy Claus, why? Why are you taking our Perl module? WHY?</h2>
<h3 align="center">by Bill 'N1VUX' Ricker</h3>
<p>The <tt>xml_grep</tt> utility and <a href="http://xmltwig.com/xmltwig/twig_stable.html#XML_Twig_101">XML-Twig 101</a> are good intros to the <tt><a href="http://search.cpan.org/perldoc?XML::Twig">XML::Twig</a></tt> suite, but that does not make for a very interesting Calendar entry.</p>
<p>As you may have noticed, this year's Advent Calendar layout does not obscure the picture with the calendar squares (window shutters), but also does not have a full 25 windows. Since we have missed some days the last few years, this should not be a problem, right? Well, the X-Y coords and dates are hard coded, so skipping a day requires some fussy work. This clearly calls for a Perl script to parse the HTML file and increment the Day of all unused entries (only), to be run when we take a skip day. In case the authors and editors are very naughty or lazy and skip more than 3 days -- and thus will be getting coal in their stocking -- the script can even remove the last box(es) to delete a day incrementing beyond 25th.</p>
<pre><span class="c">perl -i.bak mod6.pl index.html
mv index.html.bak index.before.html
diff -u index.before.html index.html | tee result-diff.txt
...
-&lt;br&gt;&lt;div class="q"&gt;&lt;a href="4/" style="left:425px; top:  5px"&gt;4&lt;/a&gt;&lt;/div&gt;
-&lt;br&gt;&lt;div class="q"&gt;&lt;a href="" style="left:545px; top:  5px"&gt;5&lt;/a&gt;&lt;/div&gt;
-&lt;br&gt;&lt;div class="q"&gt;&lt;a href="" style="left:665px; top:  5px"&gt;6&lt;/a&gt;&lt;/div&gt;
...
-&lt;br&gt;&lt;div class="C"&gt;&lt;a href="" style="left:  5px; top: 52px"&gt;22&lt;/a&gt;&lt;/div&gt;
...
+&lt;br /&gt;&lt;div class="q"&gt;&lt;a href="4/" style="left:425px; top:  5px"&gt;4&lt;/a&gt;&lt;/div&gt;
+&lt;br /&gt;&lt;div class="q"&gt;&lt;a href="" style="left:545px; top:  5px"&gt;6&lt;/a&gt;&lt;/div&gt;
+&lt;br /&gt;&lt;div class="q"&gt;&lt;a href="" style="left:665px; top:  5px"&gt;7&lt;/a&gt;&lt;/div&gt;
...
+&lt;br /&gt;&lt;div class="C"&gt;&lt;a href="" style="left:  5px; top: 52px"&gt;23&lt;/a&gt;&lt;/div&gt;</span></pre>
<p>The result is fairly subtle: The <a href="result-diff.txt">Diff</a> as above is somewhat opaque. if you viewed this by opening the <a href="../">calendar page</a> door -- <span style="font-style: italic">if not, you miss half the traditional seasonal fun</span> -- you may have noticed <span style="font-weight: bold">5</span> missing; if not, you may need to compare closely to the previous <a href="../index.before.html">page state</a>, to see that the boxes from <tt><span class="n">5</span>..<span class="n">22</span></tt> were incremented.</p>
<p>(Yes Virginia, there will be a Christmas door for the 25th.)</p>
<p>Since it's acting as XML, Twig does not normally respect original whitespace but the <tt><span class="w">keep_spaces</span> =</tt> 1> option assists us here.</p>
<p>XML-Twig is allergic to some HTML that is NOT well-formed XML, so until we upgrade to XHTML, the script needs to insert end-slash in to empty tags as needed and the HTML-only Entities.<sup><a href="#footnote_nest">1</a></sup></p>
<a name="mod6.pl" id="mod6.pl"></a><h2><a href="mod6.pl">mod6.pl</a></h2><pre>
   1 <span class="k">use</span> <span class="w">XML::Twig</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="n">5.010</span><span class="sc">;</span>
   3 
   4 <span class="k">my</span> <span class="i">$t</span> = <span class="w">XML::Twig</span><span class="w">-&gt;new</span><span class="s">(</span>
   5     <span class="w">pretty_print</span> <span class="cm">=&gt;</span> <span class="q">&#39;indented&#39;</span><span class="cm">,</span>  <span class="c"># output  nicely formatted</span>
   6     <span class="w">keep_spaces</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>             <span class="c"># wrap as original layout</span>
   7     <span class="w">empty_tags</span>   <span class="cm">=&gt;</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span>        <span class="c"># outputs &lt;empty_tag /&gt;</span>
   8 <span class="s">)</span><span class="sc">;</span>
   9 
  10 <span class="i">$contents</span> = <span class="k">do</span> <span class="s">{</span> <span class="k">local</span> <span class="i">$/</span><span class="sc">;</span> &lt;&gt; <span class="s">}</span><span class="sc">;</span>    <span class="c"># slurp scarf</span>
  11 
  12 <span class="c"># repair html to wellformed xml</span>
  13 <span class="i">$contents</span> =~ <span class="q">s[&lt; $_ (?: \b [^&gt;]*? [^/])? \K &gt;][ /&gt;]gxism</span> <span class="k">for</span> <span class="q">qw[ link br img]</span><span class="sc">;</span>
  14 <span class="i">$contents</span> =~ <span class="q">s[&amp;middot;][&amp;#183;]gxism</span><span class="sc">;</span>
  15 
  16 <span class="k">eval</span> <span class="s">{</span> <span class="i">$t</span><span class="i">-&gt;parse</span><span class="s">(</span><span class="i">$contents</span><span class="s">)</span> <span class="s">}</span>
  17    <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;$@ \n contents = $contents\n&quot;</span><span class="sc">;</span>
  18    <span class="sc">;</span>
  19 <span class="k">my</span> <span class="i">$root</span> = <span class="i">$t</span><span class="i">-&gt;root</span><span class="sc">;</span>
  20 <span class="k">my</span> <span class="i">@para</span> =
  21   <span class="i">$root</span><span class="i">-&gt;get_xpath</span><span class="s">(</span><span class="q">&#39;.//a[@href=&quot;&quot;]&#39;</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># get the  children [@class=&quot;q&quot;]/a</span>
  22 <span class="k">foreach</span> <span class="k">my</span> <span class="i">$para</span> <span class="s">(</span><span class="i">@para</span><span class="s">)</span> <span class="s">{</span>
  23     <span class="i">$para</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">$para</span><span class="i">-&gt;text</span><span class="s">(</span><span class="s">)</span> + <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
  24     <span class="i">$para</span><span class="i">-&gt;delete</span><span class="s">(</span><span class="s">)</span> <span class="k">if</span> <span class="i">$para</span><span class="i">-&gt;text</span><span class="s">(</span><span class="s">)</span> &gt; <span class="n">25</span><span class="sc">;</span>
  25 <span class="s">}</span>
  26 
  27 <span class="c"># output the document</span>
  28 <span class="i">$contents</span> = <span class="i">$t</span><span class="i">-&gt;sprint</span><span class="s">(</span><span class="i">$root</span><span class="s">)</span><span class="sc">;</span>           
  29 <span class="i">$contents</span> =~ <span class="q">s[\xb7][&amp;middot;]gxism</span><span class="sc">;</span>     <span class="c"># restore html entities</span>
  30 <span class="k">print</span> <span class="i">$contents</span><span class="sc">;</span>
  31 
</pre>
<p><a name="footnote_nest" id="footnote_nest"></a>1. This does mean that <tt>&lt;p&gt;</tt> tags need close tags <tt>&lt;/p&gt;</tt>, and tags must be properly nested, <span style="font-weight: bold"> not </span> straddled like <tt>&lt;b&gt;&lt;i&gt; blah &lt;/b&gt;&lt;/i&gt;</tt>.<br>
</p>
<div style="float: right; font-size: 10pt"><a href="mod56.pod">View Source (POD)</a></div><br />
</body>
</html>
